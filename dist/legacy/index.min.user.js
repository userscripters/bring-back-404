// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Brings back 404 pages to Stack Exchange network
// @grant           none
// @homepage        https://github.com/userscripters/bring-back-404#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            bring-back-404
// @namespace       userscripters
// @source          git+https://github.com/userscripters/bring-back-404.git
// @supportURL      https://github.com/userscripters/bring-back-404/issues
// @version         0.7.0
// ==/UserScript==

"use strict";var __read=this&&this.__read||function(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var n,i,r=a.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(n=r.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return s},__spreadArray=this&&this.__spreadArray||function(e,t){for(var a=0,n=t.length,i=e.length;a<n;a++,i++)e[i]=t[a];return e};!function(d,g,l){var u=(r.clear=function(){var e=this.storage,t=this.prefix;e.removeItem(t)},r.open=function(){var e=this.storage,t=this.prefix,t=e.getItem(t);return t?JSON.parse(t):{}},r.load=function(e,t){e=r.open()[e];return void 0!==e?e:t},r.save=function(e,t){var a=this.storage,n=this.prefix,i=r.open();i[e]=t,a.setItem(n,JSON.stringify(i))},r.toggle=function(e){return r.save(e,!r.load(e))},r.remove=function(e){var t=this.prefix,t=this.load(t,{});return delete t[e],r.save(e,t)},r.storage=localStorage,r.prefix="bring-back-404",r);function r(){}var m=function(e,t,a){var n=void 0===a?{}:a,i=n.classes,r=void 0===i?[]:i,s=n.placeholder,o=void 0===s?"":s,a=n.value,i=void 0===a?"":a,s=g.createElement("div");(n=s.classList).add.apply(n,__spreadArray(["d-flex","gs4","gsy","fd-column"],__read(r)));a=g.createElement("div");a.classList.add("flex--item");n=g.createElement("label");n.classList.add("d-block","s-label"),n.htmlFor=e,n.textContent=t;r=g.createElement("div");r.classList.add("d-flex","ps-relative");t=g.createElement("input");return t.classList.add("s-input"),t.id=e,t.type="text",t.placeholder=o,t.value=i,a.append(n),r.append(t),s.append(a,r),[s,t,n]},p=function(e,t){var a="http://www.w3.org/2000/svg",n=__read(function(e,t,a){var n=g.createElementNS(a=void 0===a?"http://www.w3.org/2000/svg":a,"svg");n.classList.add("svg-icon",e),n.setAttribute("width","18"),n.setAttribute("height","18"),n.setAttribute("viewBox","0 0 18 18"),n.setAttribute("aria-hidden","true");a=g.createElementNS(a,"path");return a.setAttribute("d",t),n.append(a),[n,a]}("iconGlobe","M9 1C4.64 1 1 4.64 1 9c0 4.36 3.64 8 8 8 4.36 0 8-3.64 8-8\n            0-4.36-3.64-8-8-8zM8 15.32a6.46 6.46 0 01-4.3-2.74 6.46 6.46\n            0 0 1-.93-5.01L7 11.68v.8c0 .88.12 1.32 1\n            1.32v1.52zm5.72-2c-.2-.66-1-1.32-1.72-1.32h-1v-2c0-.44-.56-1-1-1H6V7h1c.44\n            0 1-.56 1-1V5h2c.88 0 1.4-.72 1.4-1.6v-.33a6.45 6.45 0 013.83 4.51 6.45 6.45\n            0 0 1-1.51 5.73v.01z",a),2),i=n[0],r=n[1],n=g.createElementNS(a,"title");n.textContent=t,i.append(n);a=g.createElementNS(a,"a");return a.setAttribute("href",e),a.setAttribute("target","_blank"),a.append(r),i.append(a),i},h=function(o){g.addEventListener("dragstart",function(e){var t=e.dataTransfer,e=g.createElement("img");e.src="data:image/png;base64,AAAAAA==",null!=t&&t.setDragImage(e,0,0)});function t(e){var t,a,n,i=e.clientX,r=e.clientY,s=g.getElementById(o);s&&(c=c||i,l=l||r,t=(a=s.style).top,e=a.left,t||e||(t=(n=d.getComputedStyle(s)).top,e=n.left),[a=i-c,n=r-l].map(Math.abs).some(function(e){return 500<e})||((s=s.style).left=parseInt(e)+a+"px",s.top=parseInt(t)+n+"px",c=i,l=r))}var c=0,l=0,a=0,n=!1;g.addEventListener("dragstart",function(e){e.target===g.getElementById(o)&&(n=!0)}),g.addEventListener("dragend",function(e){e.target===g.getElementById(o)&&(n=!1,l=c=0)}),g.addEventListener("drag",function(e){if(!(3<=(a=e.clientX?0:a<3?a+1:3))&&n)return t(e)}),g.addEventListener("dragover",function(e){if(n&&e.preventDefault(),!(a<3)&&n)return t(e)})},f=(Object.defineProperty(e.prototype,"notFoundURL",{get:function(){var e=this.site;return this.url||"https://"+e+".com/404"},enumerable:!1,configurable:!0}),e);function e(e){Object.assign(this,e)}var a=[{label:"Stack Overflow",site:"stackoverflow",imageURL:"https://i.stack.imgur.com/okzBE.png"},{label:"Meta Stack Overflow",site:"meta.stackoverflow",imageURL:"https://i.stack.imgur.com/0i2to.png"},{label:"Ask Ubuntu",site:"askubuntu",imageURL:"https://i.stack.imgur.com/KopoQ.png"},{label:"Super User",site:"superuser",imageURL:"https://i.stack.imgur.com/hMfYx.png"},{label:"English Language Learners",site:"english.stackexchange",imageURL:"https://i.stack.imgur.com/cQLRt.png"},{label:"Code Review",site:"codereview.stackexchange",imageURL:"https://i.stack.imgur.com/R4Tgd.png"},{label:"Unix & Linux",site:"unix.stackexchange",imageURL:"https://i.stack.imgur.com/XQRh5.png"},{label:"Science Fiction & Fantasy",site:"scifi.stackexchange",imageURL:"https://i.stack.imgur.com/UR35t.png"},{label:"Mathematics",site:"math.stackexchange",imageURL:"https://i.stack.imgur.com/bHpU1.png"},{label:"Server Fault",site:"serverfault",imageURL:"https://i.stack.imgur.com/W7VMk.png"},{label:"Ask Different",site:"apple.stackexchange",imageURL:"https://i.stack.imgur.com/fCIaP.png"},{label:"Cross Validated",site:"stats.stackexchange",imageURL:"https://i.stack.imgur.com/BqaS0.png"},{label:"Arqade",site:"gaming.stackexchange",imageURL:"https://i.stack.imgur.com/C4jC1.png"},{label:"Mi Yodeya",site:"judaism.stackexchange",imageURL:"https://i.stack.imgur.com/048MA.png"},{label:"Webmasters",site:"webmasters.stackexchange",imageURL:"https://i.stack.imgur.com/Z8Y2o.png"},{label:"Cryptography",site:"crypto.stackexchange",imageURL:"https://i.stack.imgur.com/2hyIe.png"},{label:"Seasoned Advice",site:"cooking.stackexchange",imageURL:"https://i.stack.imgur.com/kSX5n.png"},{label:"Home Improvement",site:"diy.stackexchange",imageURL:"https://i.stack.imgur.com/C4P5L.png"},{label:"Chemistry",site:"chemistry.stackexchange",imageURL:"https://i.stack.imgur.com/SwIib.png"},{label:"Raspberry Pi",site:"raspberrypi.stackexchange",imageURL:"https://i.stack.imgur.com/A02um.png"},{label:"Emacs",site:"emacs.stackexchange",imageURL:"https://i.stack.imgur.com/KUafD.png"}].map(function(e){return new f(e)});u.load("overrides",[]).forEach(function(t){var e=a.find(function(e){return e.site===t.site});if(!e)return a.push(new f(t));Object.assign(e,t)}),function(e){var t=e.createElement("style");e.head.append(t);t=t.sheet;t&&(t.insertRule(".s-modal--dialog[draggable=true] { cursor: grab; }"),t.insertRule(".iconGlobe path { fill: var(--black-400) !important; }"))}(g),function(e){var t="bring-back-404",a=g.querySelector("ol.user-logged-in, ol.user-logged-out");if(!a)return console.debug("failed to find main menu");var n,t=g.getElementById(t)||function(e){var t=g.createElement("li");t.classList.add("-item"),t.id=e,t.dataset.action="s-modal#toggle";var a=g.createElement("a");a.classList.add("-link");e=g.createElement("strong");return e.textContent="404",a.append(e),t.append(a),t}(t);t.isConnected||(a.append(t),n="bring-back-404-config",t.addEventListener("click",function(){return a.append(function(e,n){var t="modal-title",a=g.createElement("aside");a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",t),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true");var i=a.dataset;i.sModalTarget="modal",i.controller="s-modal";var r=g.createElement("div");r.classList.add("s-modal--dialog","ps-relative","hmx6"),r.setAttribute("role","document"),r.id=e+"-document",r.draggable=!0,h(r.id);var s=g.createElement("h1");s.classList.add("s-modal--header"),s.id=t,s.textContent="Custom 404 Options";var o=g.createElement("form");o.classList.add("s-modal--body","d-flex","flex__allcells6","fw-wrap","gs16"),o.addEventListener("change",function(e){var t=e.target,a=t.id,e=t.value,t=n.find(function(e){return e.site===a});t?Object.assign(t,{imageURL:e}):n.push(new f({site:a,imageURL:e,url:l.hostname})),u.save("overrides",n)});var c=["flex--item"],i=n.map(function(e){var t=e.imageURL,a=e.site,n=e.label,e=e.notFoundURL,n=n||a,a=__read(m(a,n,{value:t,classes:c}),3),t=a[0],a=(a[1],a[2]);return a.append(g.createTextNode(" "),p(e,n+" 404 page")),a.classList.add("mb8"),t});o.append.apply(o,__spreadArray([],__read(i)));e=g.createElement("button");e.classList.add("s-modal--close","s-btn","s-btn__muted"),e.type="button",e.dataset.action="s-modal#hide";t="http://www.w3.org/2000/svg",i=g.createElementNS(t,"svg");i.setAttribute("aria-hidden","true"),i.setAttribute("viewBox","0 0 14 14"),i.setAttribute("width","14"),i.setAttribute("height","14"),i.classList.add("svg-icon","iconClearSm");t=g.createElementNS(t,"path");return t.setAttribute("d","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"),i.append(t),e.append(i),r.append(s,o,e),a.append(r),a}(n,e))},{once:!0}),t.addEventListener("click",function(e){var t;e.preventDefault();e=g.getElementById(n);e&&null!==(t=d.Stacks)&&void 0!==t&&t.showModal(e)}))}(a);var n,t,i,s=l.hostname.split(".").slice(0,-1).join("."),o=a.find(function(e){return e.site===s});if(!o)return console.debug("not on supported site: "+s);n=g,t=(t=o).imageURL,(i=n.createElement("img")).src=t,i.alt="Page not found",i.decoding="async",i.width=250,i.style.display="none",i.addEventListener("error",function(){return console.debug("failed to load 404 image on "+s)}),i.addEventListener("load",function(){var e=n.getElementById("content");if(!e)return console.debug("missing content modal");var t=e.querySelector("svg.spotAlertXL, [alt='Page not found']");if(!t)return console.debug("missing 404 image");t.replaceWith(i),i.style.display="unset";e=e.querySelector("h1");if(!e)return console.debug("missing 404 header");e.classList.remove("mt48");e=e.closest(".d-flex");if(!e)return console.debug("404 content does't use Flexbox");e.classList.replace("ai-start","ai-center")}),n.body.append(i)}("undefined"!=typeof unsafeWindow?unsafeWindow:window,document,location);