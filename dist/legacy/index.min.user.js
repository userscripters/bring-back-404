// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Brings back 404 pages to Stack Exchange network
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_listValues
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/bring-back-404#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.mathoverflow.net/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @name            bring-back-404
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/bring-back-404.git
// @supportURL      https://github.com/userscripters/bring-back-404/issues
// @version         1.0.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,s,o,c){return new(o=o||Promise)(function(n,t){function a(e){try{i(c.next(e))}catch(e){t(e)}}function r(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(a,r)}i((c=c.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(n,a){var r,i,s,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=a.call(n,o)}catch(e){t=[6,e],i=0}finally{r=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__read=this&&this.__read||function(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var a,r,i=n.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(a=i.next()).done;)s.push(a.value)}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return s},__spreadArray=this&&this.__spreadArray||function(e,t){for(var n=0,a=t.length,r=e.length;n<a;n++,r++)e[r]=t[n];return e};!function(u,t,d,c){var e={GM_setValue:{get length(){return GM_listValues().length},clear:function(){return GM_listValues().forEach(function(e){return GM_deleteValue(e)})},key:function(e){return GM_listValues()[e]},getItem:function(e){return GM_getValue(e)},setItem:function(e,t){return GM_setValue(e,t)},removeItem:function(e){return GM_deleteValue(e)}},GM:{get length(){return GM.listValues().then(function(e){return e.length})},clear:function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,GM.listValues()];case 1:return[2,e.sent().forEach(function(e){return GM.deleteValue(e)})]}})})},key:function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,GM.listValues()];case 1:return[2,e.sent()[t]]}})})},getItem:function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,GM.getValue(n)];case 1:return[2,void 0===(t=e.sent())?null:null==t?void 0:t.toString()]}})})},setItem:function(e,t){return GM.setValue(e,t)},removeItem:function(e){return GM.deleteValue(e)}}},e=__read(Object.entries(e).find(function(e){e=__read(e,1)[0];return void 0!==t[e]})||[],2)[1],l=(s.clear=function(){var e=this.storage,t=this.prefix;e.removeItem(t)},s.open=function(){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return t=(n=this).storage,n=n.prefix,[4,t.getItem(n)];case 1:return[2,(n=e.sent())?JSON.parse(n):{}]}})})},s.load=function(n,a){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,s.open()];case 1:return[2,void 0!==(t=e.sent()[n])?t:a]}})})},s.save=function(r,i){return __awaiter(this,void 0,void 0,function(){var t,n,a;return __generator(this,function(e){switch(e.label){case 0:return t=(a=this).storage,n=a.prefix,[4,s.open()];case 1:return(a=e.sent())[r]=i,[2,t.setItem(n,JSON.stringify(a))]}})})},s.toggle=function(r){return __awaiter(this,void 0,void 0,function(){var t,n,a;return __generator(this,function(e){switch(e.label){case 0:return n=(t=s).save,a=[r],[4,s.load(r)];case 1:return[2,n.apply(t,a.concat([!e.sent()]))]}})})},s.remove=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=this.prefix,[4,this.load(t,{})];case 1:return delete(t=e.sent())[n],[2,s.save(n,t)]}})})},s.storage=e||localStorage,s.prefix="bring-back-404",s);function s(){}function o(e){var n,t="bring-back-404",a=d.querySelector("ol.user-logged-in, ol.user-logged-out");if(!a)return console.debug("failed to find main menu");(t=d.getElementById(t)||function(e){var t=d.createElement("li");t.classList.add("-item"),t.id=e,t.dataset.action="s-modal#toggle";var n=d.createElement("a");n.classList.add("-link");e=d.createElement("strong");return e.textContent="404",n.append(e),t.append(n),t}(t)).isConnected||(a.append(t),n="bring-back-404-config",t.addEventListener("click",function(){return a.append(function(e,i){var t="modal-title",n=d.createElement("aside");n.classList.add("s-modal"),n.id=e,n.tabIndex=-1,n.setAttribute("role","dialog"),n.setAttribute("aria-labelledby",t),n.setAttribute("aria-describeddy","modal-description"),n.setAttribute("aria-hidden","true");var a=n.dataset;a.sModalTarget="modal",a.controller="s-modal";var r=d.createElement("div");r.classList.add("s-modal--dialog","ps-relative","hmx6"),r.setAttribute("role","document"),r.id=e+"-document",r.draggable=!0,p(r.id);var s=d.createElement("h1");s.classList.add("s-modal--header"),s.id=t,s.textContent="Custom 404 Options";var o=d.createElement("form");o.classList.add("s-modal--body","d-flex","flex__allcells6","fw-wrap","gs16"),o.addEventListener("change",function(e){var t,n=e.target,a=n.id,e=n.value,n=__read(a.split("-"),2),r=n[0],a=n[1],n=i.find(function(e){return e.site===r});n?Object.assign(n,((t={})[a]=e,t)):i.push(new h(((t={site:r})[a]=e,t.url=c.hostname,t))),l.save("overrides",i)});a=i.map(function(e){var t=e.imageURL,n=e.site,a=e.label,r=e.notFoundURL,i=e.header,s=a||n,e=d.createElement("div");e.classList.add("flex--item");a=__read(g(n+"-imageURL",{value:t,title:s}),3),t=a[0],a[1],a=a[2];a.append(d.createTextNode(" "),m(r,s+" 404 page")),a.classList.add("mb8");i=__read(g(n+"-header",{placeholder:"custom header",value:i||""}),1)[0];return e.append(t,i),e});o.append.apply(o,__spreadArray([],__read(a)));e=d.createElement("button");e.classList.add("s-modal--close","s-btn","s-btn__muted"),e.type="button",e.dataset.action="s-modal#hide";t="http://www.w3.org/2000/svg",a=d.createElementNS(t,"svg");a.setAttribute("aria-hidden","true"),a.setAttribute("viewBox","0 0 14 14"),a.setAttribute("width","14"),a.setAttribute("height","14"),a.classList.add("svg-icon","iconClearSm");t=d.createElementNS(t,"path");return t.setAttribute("d","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"),a.append(t),e.append(a),r.append(s,o,e),n.append(r),n}(n,e))},{once:!0}),t.addEventListener("click",function(e){var t;e.preventDefault();e=d.getElementById(n);e&&null!==(t=u.Stacks)&&void 0!==t&&t.showModal(e)}))}var g=function(e,t){var n=void 0===t?{}:t,a=n.classes,r=void 0===a?[]:a,i=n.placeholder,s=void 0===i?"":i,t=n.title,a=void 0===t?"":t,i=n.value,t=void 0===i?"":i,n=d.createElement("div");(i=n.classList).add.apply(i,__spreadArray(["d-flex","gs4","gsy","fd-column"],__read(r)));i=d.createElement("div");i.classList.add("d-flex","ps-relative");r=d.createElement("input");if(r.classList.add("s-input"),r.id=e,r.type="text",r.placeholder=s,r.value=t,i.append(r),n.append(i),a){t=d.createElement("div");t.classList.add("flex--item");i=d.createElement("label");return i.classList.add("d-block","s-label"),i.htmlFor=e,i.textContent=a,t.append(i),n.prepend(t),[n,r,i]}return[n,r]},m=function(e,t){var n="http://www.w3.org/2000/svg",a=__read(function(e,t,n){var a=d.createElementNS(n=void 0===n?"http://www.w3.org/2000/svg":n,"svg");a.classList.add("svg-icon",e),a.setAttribute("width","18"),a.setAttribute("height","18"),a.setAttribute("viewBox","0 0 18 18"),a.setAttribute("aria-hidden","true");n=d.createElementNS(n,"path");return n.setAttribute("d",t),a.append(n),[a,n]}("iconGlobe","M9 1C4.64 1 1 4.64 1 9c0 4.36 3.64 8 8 8 4.36 0 8-3.64 8-8\n            0-4.36-3.64-8-8-8zM8 15.32a6.46 6.46 0 01-4.3-2.74 6.46 6.46\n            0 0 1-.93-5.01L7 11.68v.8c0 .88.12 1.32 1\n            1.32v1.52zm5.72-2c-.2-.66-1-1.32-1.72-1.32h-1v-2c0-.44-.56-1-1-1H6V7h1c.44\n            0 1-.56 1-1V5h2c.88 0 1.4-.72 1.4-1.6v-.33a6.45 6.45 0 013.83 4.51 6.45 6.45\n            0 0 1-1.51 5.73v.01z",n),2),r=a[0],i=a[1],a=d.createElementNS(n,"title");a.textContent=t,r.append(a);n=d.createElementNS(n,"a");return n.setAttribute("href",e),n.setAttribute("target","_blank"),n.append(i),r.append(n),r},p=function(o){d.addEventListener("dragstart",function(e){var t=e.dataTransfer,e=d.createElement("img");e.src="data:image/png;base64,AAAAAA==",null!=t&&t.setDragImage(e,0,0)});function t(e){var t,n,a,r=e.clientX,i=e.clientY,s=d.getElementById(o);s&&(c=c||r,l=l||i,t=(n=s.style).top,e=n.left,t||e||(t=(a=u.getComputedStyle(s)).top,e=a.left),[n=r-c,a=i-l].map(Math.abs).some(function(e){return 500<e})||((s=s.style).left=parseInt(e)+n+"px",s.top=parseInt(t)+a+"px",c=r,l=i))}var c=0,l=0,n=0,a=!1;d.addEventListener("dragstart",function(e){e.target===d.getElementById(o)&&(a=!0)}),d.addEventListener("dragend",function(e){e.target===d.getElementById(o)&&(a=!1,l=c=0)}),d.addEventListener("drag",function(e){if(!(3<=(n=e.clientX?0:n<3?n+1:3))&&a)return t(e)}),d.addEventListener("dragover",function(e){if(a&&e.preventDefault(),!(n<3)&&a)return t(e)})},h=(Object.defineProperty(n.prototype,"notFoundURL",{get:function(){var e=this.site;return this.url||"https://"+e+".com/404"},enumerable:!1,configurable:!0}),n);function n(e){Object.assign(this,e)}var f=[{label:"Stack Overflow",site:"stackoverflow",imageURL:"https://i.stack.imgur.com/okzBE.png"},{label:"Meta Stack Overflow",site:"meta.stackoverflow",imageURL:"https://i.stack.imgur.com/0i2to.png"},{label:"Ask Ubuntu",site:"askubuntu",imageURL:"https://i.stack.imgur.com/KopoQ.png"},{label:"Super User",site:"superuser",imageURL:"https://i.stack.imgur.com/hMfYx.png"},{label:"English Language Learners",site:"english.stackexchange",imageURL:"https://i.stack.imgur.com/cQLRt.png"},{label:"Code Review",site:"codereview.stackexchange",imageURL:"https://i.stack.imgur.com/R4Tgd.png"},{label:"Unix & Linux",site:"unix.stackexchange",imageURL:"https://i.stack.imgur.com/XQRh5.png"},{label:"Science Fiction & Fantasy",site:"scifi.stackexchange",imageURL:"https://i.stack.imgur.com/UR35t.png"},{label:"Mathematics",site:"math.stackexchange",imageURL:"https://i.stack.imgur.com/bHpU1.png"},{label:"Server Fault",site:"serverfault",imageURL:"https://i.stack.imgur.com/W7VMk.png"},{label:"Ask Different",site:"apple.stackexchange",imageURL:"https://i.stack.imgur.com/fCIaP.png"},{label:"Cross Validated",site:"stats.stackexchange",imageURL:"https://i.stack.imgur.com/BqaS0.png"},{label:"Arqade",site:"gaming.stackexchange",imageURL:"https://i.stack.imgur.com/C4jC1.png"},{label:"Mi Yodeya",site:"judaism.stackexchange",imageURL:"https://i.stack.imgur.com/048MA.png"},{label:"Webmasters",site:"webmasters.stackexchange",imageURL:"https://i.stack.imgur.com/Z8Y2o.png"},{label:"Cryptography",site:"crypto.stackexchange",imageURL:"https://i.stack.imgur.com/2hyIe.png"},{label:"Seasoned Advice",site:"cooking.stackexchange",imageURL:"https://i.stack.imgur.com/kSX5n.png"},{label:"Home Improvement",site:"diy.stackexchange",imageURL:"https://i.stack.imgur.com/C4P5L.png"},{label:"Chemistry",site:"chemistry.stackexchange",imageURL:"https://i.stack.imgur.com/SwIib.png"},{label:"Raspberry Pi",site:"raspberrypi.stackexchange",imageURL:"https://i.stack.imgur.com/A02um.png"},{label:"Emacs",site:"emacs.stackexchange",imageURL:"https://i.stack.imgur.com/KUafD.png"},{label:"Android Enthusiasts",site:"android.stackexchange",imageURL:"https://i.stack.imgur.com/kgFiY.png"},{label:"Graphic Design",site:"graphicdesign.stackexchange",imageURL:"https://i.stack.imgur.com/FwQQL.png"},{label:"Database Administrators",site:"dba.stackexchange",imageURL:"https://i.stack.imgur.com/ly6am.png"}].map(function(e){return new h(e)});t.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var i,s;return __generator(this,function(e){switch(e.label){case 0:return[4,l.load("overrides",[])];case 1:return e.sent().forEach(function(t){var e=f.find(function(e){return e.site===t.site});if(!e)return f.push(new h(t));Object.assign(e,t)}),function(e){var t=e.createElement("style");e.head.append(t);t=t.sheet;t&&(t.insertRule(".s-modal--dialog[draggable=true] { cursor: grab; }"),t.insertRule(".iconGlobe path { fill: var(--black-400) !important; }"))}(d),o(f),s=c.hostname,i=s.split(".").slice(0,-1).join("."),s=f.find(function(e){return e.site===i})||new h({site:i,header:"Arrrggghhh!",imageURL:"https://i.stack.imgur.com/ata1R.jpg"}),n=d,t=void 0===(t=s.imageURL)?"":t,a=s.site,(r=n.createElement("img")).src=t,r.alt="Page not found",r.decoding="async",r.width=250,r.style.display="none",r.addEventListener("error",function(){return console.debug("failed to load 404 image on "+a)}),r.addEventListener("load",function(){var e=n.getElementById("content");if(!e)return console.debug("missing content modal");var t=e.querySelector("svg.spotAlertXL, [alt='Page not found']");if(!t)return console.debug("missing 404 image");t.replaceWith(r),r.style.display="unset";e=e.querySelector("h1");if(!e)return console.debug("missing 404 header");e.classList.remove("mt48");e=e.closest(".d-flex");if(!e)return console.debug("404 content does't use Flexbox");e.classList.replace("ai-start","ai-center")}),n.body.append(r),function(e,t){t=t.header,e=e.getElementById("content");if(!e)return console.debug("missing content modal");e=e.querySelector("h1");t&&e&&(e.textContent=t)}(d,s),[2]}var n,t,a,r})})})}("undefined"!=typeof unsafeWindow?unsafeWindow:window,window,document,location);