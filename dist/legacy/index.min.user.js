// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Brings back 404 pages to Stack Exchange network
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_listValues
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/bring-back-404#readme
// @match           https://*.stackexchange.com/*
// @match           https://askubuntu.com/*
// @match           https://es.meta.stackoverflow.com/*
// @match           https://es.stackoverflow.com/*
// @match           https://ja.meta.stackoverflow.com/*
// @match           https://ja.stackoverflow.com/*
// @match           https://mathoverflow.net/*
// @match           https://meta.askubuntu.com/*
// @match           https://meta.mathoverflow.net/*
// @match           https://meta.serverfault.com/*
// @match           https://meta.stackoverflow.com/*
// @match           https://meta.superuser.com/*
// @match           https://pt.meta.stackoverflow.com/*
// @match           https://pt.stackoverflow.com/*
// @match           https://ru.meta.stackoverflow.com/*
// @match           https://ru.stackoverflow.com/*
// @match           https://serverfault.com/*
// @match           https://stackapps.com/*
// @match           https://stackoverflow.com/*
// @match           https://superuser.com/*
// @name            Bring Back 404
// @namespace       userscripters
// @require         https://github.com/userscripters/storage/raw/master/dist/browser.js
// @run-at          document-start
// @source          git+https://github.com/userscripters/bring-back-404.git
// @supportURL      https://github.com/userscripters/bring-back-404/issues
// @version         1.2.0
// ==/UserScript==

"use strict";var __awaiter=this&&this.__awaiter||function(e,s,c,o){return new(c=c||Promise)(function(a,t){function n(e){try{r(o.next(e))}catch(e){t(e)}}function i(e){try{r(o.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?a(e.value):((t=e.value)instanceof c?t:new c(function(e){e(t)})).then(n,i)}r((o=o.apply(e,s||[])).next())})},__generator=this&&this.__generator||function(n,i){var r,s,c,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(a){return function(e){var t=[a,e];if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,s&&(c=2&t[0]?s.return:t[0]?s.throw||((c=s.return)&&c.call(s),0):s.next)&&!(c=c.call(s,t[1])).done)return c;switch(s=0,(t=c?[2&t[0],c.value]:t)[0]){case 0:case 1:c=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,s=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(c=0<(c=o.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){o.label=t[1];break}if(6===t[0]&&o.label<c[1]){o.label=c[1],c=t;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(t);break}c[2]&&o.ops.pop(),o.trys.pop();continue}t=i.call(n,o)}catch(e){t=[6,e],s=0}finally{r=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}}},__read=this&&this.__read||function(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var n,i,r=a.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(n=r.next()).done;)s.push(n.value)}catch(e){i={error:e}}finally{try{n&&!n.done&&(a=r.return)&&a.call(r)}finally{if(i)throw i.error}}return s},__spreadArray=this&&this.__spreadArray||function(e,t,a){if(a||2===arguments.length)for(var n,i=0,r=t.length;i<r;i++)!n&&i in t||((n=n||Array.prototype.slice.call(t,0,i))[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))};!function(m,e,p,h){function l(l,d){var u,e="bring-back-404",g=p.querySelector("ol.s-topbar--content");if(!g)return console.debug("failed to find main menu");(e=p.getElementById(e)||function(e){var t=p.createElement("li");t.id=e;t.dataset.action="s-modal#toggle";var e=p.createElement("a"),a=(e.classList.add("s-topbar--item"),p.createElement("strong"));return a.textContent="404",e.append(a),t.append(e),t}(e)).isConnected||(g.append(e),u="bring-back-404-config",e.addEventListener("click",function(){return g.append((i=l,e=u,r=d,t="modal-title",(a=p.createElement("aside")).classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",t),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),(n=a.dataset).sModalTarget="modal",n.controller="s-modal",(n=p.createElement("div")).classList.add("s-modal--dialog","ps-relative","hmx6"),n.setAttribute("role","document"),n.id="".concat(e,"-document"),n.draggable=!0,v(n.id),(e=p.createElement("h1")).classList.add("s-modal--header"),e.id=t,e.textContent="Custom 404 Options",(t=p.createElement("form")).classList.add("s-modal--body","d-flex","flex__allitems6","fw-wrap","gs16"),t.addEventListener("change",function(e){var e=e.target,t=e.id,e=e.value,t=__read(t.split("-"),2),a=t[0],t=t[1],n=r.find(function(e){return e.site===a});n?Object.assign(n,((n={})[t]=e,n)):r.push(new k(((n={site:a})[t]=e,n.url=h.hostname,n))),i.save("overrides",r)}),s=r.map(function(e){var t=e.imageURL,a=e.site,n=e.label,i=e.notFoundURL,e=e.header,n=n||a,r=p.createElement("div"),t=(r.classList.add("flex--item"),__read(f("".concat(a,"-imageURL"),{value:t,title:n}),3)),s=t[0],t=(t[1],t[2]);t.append(p.createTextNode(" "),b(i,"".concat(n," 404 page"))),t.classList.add("mb8");i=__read(f("".concat(a,"-header"),{placeholder:"custom header",value:e||""}),1)[0];return r.append(s,i),r}),t.append.apply(t,__spreadArray([],__read(s),!1)),(s=p.createElement("button")).classList.add("s-modal--close","s-btn","s-btn__muted"),s.type="button",s.dataset.action="s-modal#hide",c="http://www.w3.org/2000/svg",(o=p.createElementNS(c,"svg")).setAttribute("aria-hidden","true"),o.setAttribute("viewBox","0 0 14 14"),o.setAttribute("width","14"),o.setAttribute("height","14"),o.classList.add("svg-icon","iconClearSm"),(c=p.createElementNS(c,"path")).setAttribute("d","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"),o.append(c),s.append(o),n.append(e,t,s),a.append(n),a));var i,e,r,t,a,n,s,c,o},{once:!0}),e.addEventListener("click",function(e){e.preventDefault();var t,e=p.getElementById(u);e&&null!=(t=m.Stacks)&&t.showModal(e)}))}var f=function(e,t){var t=void 0===t?{}:t,a=t.classes,a=void 0===a?[]:a,n=t.placeholder,n=void 0===n?"":n,i=t.title,i=void 0===i?"":i,t=t.value,t=void 0===t?"":t,r=p.createElement("div"),s=((s=r.classList).add.apply(s,__spreadArray(["d-flex","gs4","gsy","fd-column"],__read(a),!1)),p.createElement("div")),a=(s.classList.add("d-flex","ps-relative"),p.createElement("input"));return a.classList.add("s-input"),a.id=e,a.type="text",a.placeholder=n,a.value=t,s.append(a),r.append(s),i?((n=p.createElement("div")).classList.add("flex--item"),(t=p.createElement("label")).classList.add("d-block","s-label"),t.htmlFor=e,t.textContent=i,n.append(t),r.prepend(n),[r,a,t]):[r,a]},b=function(e,t){var a="http://www.w3.org/2000/svg",n=__read((s="iconGlobe",i="M9 1C4.64 1 1 4.64 1 9c0 4.36 3.64 8 8 8 4.36 0 8-3.64 8-8\n            0-4.36-3.64-8-8-8zM8 15.32a6.46 6.46 0 01-4.3-2.74 6.46 6.46\n            0 0 1-.93-5.01L7 11.68v.8c0 .88.12 1.32 1\n            1.32v1.52zm5.72-2c-.2-.66-1-1.32-1.72-1.32h-1v-2c0-.44-.56-1-1-1H6V7h1c.44\n            0 1-.56 1-1V5h2c.88 0 1.4-.72 1.4-1.6v-.33a6.45 6.45 0 013.83 4.51 6.45 6.45\n            0 0 1-1.51 5.73v.01z",n=a,(r=p.createElementNS(n=void 0===n?"http://www.w3.org/2000/svg":n,"svg")).classList.add("svg-icon",s),r.setAttribute("width","18"),r.setAttribute("height","18"),r.setAttribute("viewBox","0 0 18 18"),r.setAttribute("aria-hidden","true"),(s=p.createElementNS(n,"path")).setAttribute("d",i),r.append(s),[r,s]),2),i=n[0],r=n[1],s=p.createElementNS(a,"title"),n=(s.textContent=t,i.append(s),p.createElementNS(a,"a"));return n.setAttribute("href",e),n.setAttribute("target","_blank"),n.append(r),i.append(n),i},v=function(c){p.addEventListener("dragstart",function(e){var e=e.dataTransfer,t=p.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});function t(e){var t,a,n,i,r=e.clientX,e=e.clientY,s=p.getElementById(c);s&&(o=o||r,l=l||e,t=(a=s.style).top,a=a.left,t||a||(t=(n=m.getComputedStyle(s)).top,a=n.left),[n=r-o,i=e-l].map(Math.abs).some(function(e){return 500<e})||((s=s.style).left="".concat(parseInt(a)+n,"px"),s.top="".concat(parseInt(t)+i,"px"),o=r,l=e))}var o=0,l=0,a=0,n=!1;p.addEventListener("dragstart",function(e){e.target===p.getElementById(c)&&(n=!0)}),p.addEventListener("dragend",function(e){e.target===p.getElementById(c)&&(n=!1,l=o=0)}),p.addEventListener("drag",function(e){if(!(3<=(a=e.clientX?0:a<3?a+1:3))&&n)return t(e)}),p.addEventListener("dragover",function(e){if(n&&e.preventDefault(),!(a<3)&&n)return t(e)})},k=(Object.defineProperty(t.prototype,"notFoundURL",{get:function(){var e=this.site;return this.url||"https://".concat(e,".com/404")},enumerable:!1,configurable:!0}),t);function t(e){Object.assign(this,e)}var d=[{label:"Stack Overflow",site:"stackoverflow",imageURL:"https://i.stack.imgur.com/okzBE.png"},{label:"Meta Stack Overflow",site:"meta.stackoverflow",imageURL:"https://i.stack.imgur.com/0i2to.png"},{label:"Ask Ubuntu",site:"askubuntu",imageURL:"https://i.stack.imgur.com/KopoQ.png"},{label:"Super User",site:"superuser",imageURL:"https://i.stack.imgur.com/hMfYx.png"},{label:"English Language Learners",site:"english.stackexchange",imageURL:"https://i.stack.imgur.com/cQLRt.png"},{label:"Code Review",site:"codereview.stackexchange",imageURL:"https://i.stack.imgur.com/R4Tgd.png"},{label:"Unix & Linux",site:"unix.stackexchange",imageURL:"https://i.stack.imgur.com/XQRh5.png"},{label:"Science Fiction & Fantasy",site:"scifi.stackexchange",imageURL:"https://i.stack.imgur.com/UR35t.png"},{label:"Mathematics",site:"math.stackexchange",imageURL:"https://i.stack.imgur.com/bHpU1.png"},{label:"Server Fault",site:"serverfault",imageURL:"https://i.stack.imgur.com/W7VMk.png"},{label:"Ask Different",site:"apple.stackexchange",imageURL:"https://i.stack.imgur.com/fCIaP.png"},{label:"Cross Validated",site:"stats.stackexchange",imageURL:"https://i.stack.imgur.com/BqaS0.png"},{label:"Arqade",site:"gaming.stackexchange",imageURL:"https://i.stack.imgur.com/C4jC1.png"},{label:"Mi Yodeya",site:"judaism.stackexchange",imageURL:"https://i.stack.imgur.com/048MA.png"},{label:"Webmasters",site:"webmasters.stackexchange",imageURL:"https://i.stack.imgur.com/Z8Y2o.png"},{label:"Cryptography",site:"crypto.stackexchange",imageURL:"https://i.stack.imgur.com/2hyIe.png"},{label:"Seasoned Advice",site:"cooking.stackexchange",imageURL:"https://i.stack.imgur.com/kSX5n.png"},{label:"Home Improvement",site:"diy.stackexchange",imageURL:"https://i.stack.imgur.com/C4P5L.png"},{label:"Chemistry",site:"chemistry.stackexchange",imageURL:"https://i.stack.imgur.com/SwIib.png"},{label:"Raspberry Pi",site:"raspberrypi.stackexchange",imageURL:"https://i.stack.imgur.com/A02um.png"},{label:"Emacs",site:"emacs.stackexchange",imageURL:"https://i.stack.imgur.com/KUafD.png"},{label:"Android Enthusiasts",site:"android.stackexchange",imageURL:"https://i.stack.imgur.com/kgFiY.png"},{label:"Graphic Design",site:"graphicdesign.stackexchange",imageURL:"https://i.stack.imgur.com/FwQQL.png"},{label:"Database Administrators",site:"dba.stackexchange",imageURL:"https://i.stack.imgur.com/ly6am.png"},{label:"Movies & TV",site:"movies.stackexchange",imageURL:"https://i.stack.imgur.com/wCrM9.png"},{label:"Software Recommendations",site:"softwarerecs.stackexchange",imageURL:"https://i.stack.imgur.com/BqikQ.png"},{label:"Academia",site:"academia.stackexchange",imageURL:"https://i.stack.imgur.com/l10yz.png"}].map(function(e){return new k(e)});e.addEventListener("load",function(){return __awaiter(void 0,void 0,void 0,function(){var s,c,o;return __generator(this,function(e){switch(e.label){case 0:return s=Store.locateStorage(),[4,(s=new Store.default("bring-back-404",s)).load("overrides",[])];case 1:return e.sent().forEach(function(t){var e=d.find(function(e){return e.site===t.site});if(!e)return d.push(new k(t));Object.assign(e,t)}),r=(i=p).createElement("style"),i.head.append(r),(i=r.sheet)&&(i.insertRule(".s-modal--dialog[draggable=true] { cursor: grab; }"),i.insertRule(".iconGlobe path { fill: var(--black-400) !important; }")),l(s,d),[4,fetch(h.href)];case 2:return 404!==e.sent().status?[2]:(o=h.hostname,c=o.split(".").slice(0,-1).join("."),o=d.find(function(e){return e.site===c})||new k({site:c,header:"Arrrggghhh!",imageURL:"https://i.stack.imgur.com/ata1R.jpg"}),a=p,r=void 0===(r=o.imageURL)?"":r,t=o.site,(n=a.createElement("img")).src=r,n.alt="Page not found",n.decoding="async",n.width=250,n.style.display="none",n.addEventListener("error",function(){return console.debug("failed to load 404 image on ".concat(t))}),n.addEventListener("load",function(){var e=a.getElementById("content");if(!e)return console.debug("missing content modal");var t=e.querySelector("svg.spotAlertXL, [alt='Page not found']");if(!t)return console.debug("missing 404 image");t.replaceWith(n),n.style.display="unset";t=e.querySelector("h1");if(!t)return console.debug("missing 404 header");t.classList.remove("mt48");e=t.closest(".d-flex");if(!e)return console.debug("404 content does't use Flexbox");e.classList.replace("ai-start","ai-center")}),a.body.append(n),function(e,t){t=t.header,e=e.getElementById("content");if(!e)return console.debug("missing content modal");e=e.querySelector("h1:not(#question-header > h1)");t&&e&&(e.textContent=t)}(p,o),[2])}var a,t,n,i,r})})})}("undefined"!=typeof unsafeWindow?unsafeWindow:window,window,document,location);