// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Brings back 404 pages to Stack Exchange network
// @grant           none
// @homepage        https://github.com/userscripters/bring-back-404#readme
// @match           https://*.askubuntu.com/*
// @match           https://*.serverfault.com/*
// @match           https://*.stackapps.com/*
// @match           https://*.stackexchange.com/*
// @match           https://*.stackoverflow.com/*
// @match           https://*.superuser.com/*
// @name            bring-back-404
// @namespace       userscripters
// @source          git+https://github.com/userscripters/bring-back-404.git
// @supportURL      https://github.com/userscripters/bring-back-404/issues
// @version         0.3.0
// ==/UserScript==

"use strict";((m,e)=>{class p{static clear(){const{storage:e,prefix:t}=this;e.removeItem(t)}static open(){const{storage:e,prefix:t}=this;var s=e.getItem(t);return s?JSON.parse(s):{}}static load(e,t){e=p.open()[e];return void 0!==e?e:t}static save(e,t){const{storage:s,prefix:a}=this,i=p.open();i[e]=t,s.setItem(a,JSON.stringify(i))}static toggle(e){return p.save(e,!p.load(e))}static remove(e){var t=this["prefix"];const s=this.load(t,{});return delete s[e],p.save(e,s)}}p.storage=localStorage,p.prefix="bring-back-404";const u=(e,t,{classes:s=[],placeholder:a="",value:i=""}={})=>{const n=m.createElement("div");n.classList.add("d-flex","gs4","gsy","fd-column",...s);const c=m.createElement("div");c.classList.add("flex--item");const o=m.createElement("label");o.classList.add("d-block","s-label"),o.htmlFor=e,o.textContent=t;const r=m.createElement("div");r.classList.add("d-flex","ps-relative");const d=m.createElement("input");return d.classList.add("s-input"),d.id=e,d.type="text",d.placeholder=a,d.value=i,c.append(o),r.append(d),n.append(c,r),[n,d]};const s=[{site:"stackoverflow",imageURL:"https://i.stack.imgur.com/okzBE.png"},{site:"meta.stackoverflow",imageURL:"https://i.stack.imgur.com/0i2to.png"},{site:"askubuntu",imageURL:"https://i.stack.imgur.com/KopoQ.png"},{site:"superuser",imageURL:"https://i.stack.imgur.com/hMfYx.png"},{site:"english.stackexchange",imageURL:"https://i.stack.imgur.com/cQLRt.png"},{site:"codereview.stackexchange",imageURL:"https://i.stack.imgur.com/R4Tgd.png"},{site:"unix.stackexchange",imageURL:"https://i.stack.imgur.com/XQRh5.png"},{site:"scifi.stackexchange",imageURL:"https://i.stack.imgur.com/UR35t.png"},{site:"math.stackexchange",imageURL:"https://i.stack.imgur.com/bHpU1.png"},{site:"serverfault",imageURL:"https://i.stack.imgur.com/W7VMk.png"},{site:"apple.stackexchange",imageURL:"https://i.stack.imgur.com/fCIaP.png"},{site:"stats.stackexchange",imageURL:"https://i.stack.imgur.com/BqaS0.png"},{site:"gaming.stackexchange",imageURL:"https://i.stack.imgur.com/C4jC1.png"},{site:"judaism.stackexchange",imageURL:"https://i.stack.imgur.com/048MA.png"},{site:"webmasters.stackexchange",imageURL:"https://i.stack.imgur.com/Z8Y2o.png"},{site:"crypto.stackexchange",imageURL:"https://i.stack.imgur.com/2hyIe.png"},{site:"cooking.stackexchange",imageURL:"https://i.stack.imgur.com/kSX5n.png"},{site:"diy.stackexchange",imageURL:"https://i.stack.imgur.com/C4P5L.png"}],t=p.load("overrides",[]);t.forEach(t=>{var e=s.find(({site:e})=>e===t.site);if(!e)return s.push(t);Object.assign(e,t)});const a=e["hostname"],i=a.split(".").slice(0,-1).join(".");e=s.find(({site:e})=>e===i);if(!e)return console.debug(`not on supported site: ${i}`);var e=e["imageURL"];const n=m.createElement("img");n.src=e,n.alt="Page not found",n.decoding="async",n.width=250,n.style.display="none",n.addEventListener("error",()=>console.debug(`failed to load 404 image on ${i}`)),n.addEventListener("load",()=>{const e=m.getElementById("content");if(!e)return console.debug("missing content modal");const t=e.querySelector("svg.spotAlertXL, [alt='Page not found']");if(!t)return console.debug("missing 404 image");t.replaceWith(n),n.style.display="unset";const s=e.querySelector("h1");if(!s)return console.debug("missing 404 header");s.classList.remove("mt48");const a=s.closest(".d-flex");if(!a)return console.debug("404 content does't use Flexbox");a.classList.replace("ai-start","ai-center")}),m.body.append(n),(e=>{var t="bring-back-404";const s=m.querySelector("ol.user-logged-in");if(!s)return console.debug("failed to find main menu");const a=m.getElementById(t)||(e=>{const t=m.createElement("li");t.classList.add("-item"),t.id=e;const s=t["dataset"];s.action="s-modal#toggle";const a=m.createElement("a");a.classList.add("-link");const i=m.createElement("strong");return i.textContent="404",a.append(i),t.append(a),t})(t);if(!a.isConnected){s.append(a);const i="bring-back-404-config";a.addEventListener("click",()=>s.append(((e,a)=>{var t="modal-title";const s=m.createElement("aside");s.classList.add("s-modal"),s.id=e,s.tabIndex=-1,s.setAttribute("role","dialog"),s.setAttribute("aria-labelledby",t),s.setAttribute("aria-describeddy","modal-description"),s.setAttribute("aria-hidden","true");const i=s["dataset"];i.sModalTarget="modal",i.controller="s-modal";const n=m.createElement("div");n.classList.add("s-modal--dialog","ps-relative"),n.setAttribute("role","document");const c=m.createElement("h1");c.classList.add("s-modal--header"),c.id=t,c.textContent="Custom 404 Options";const o=m.createElement("form");o.classList.add("s-modal--body","d-flex","flex__allcells6","fw-wrap","gs16"),o.addEventListener("change",({target:e})=>{const{id:t,value:s}=e;e=a.find(({site:e})=>e===t);e?Object.assign(e,{imageURL:s}):a.push({site:t,imageURL:s}),p.save("overrides",a)});const r=["flex--item"];t=a.map(({imageURL:e,site:t})=>u(t,t,{value:e,classes:r})[0]);o.append(...t);const d=m.createElement("button");d.classList.add("s-modal--close","s-btn","s-btn__muted"),d.type="button",d.dataset.action="s-modal#hide";t="http://www.w3.org/2000/svg";const l=m.createElementNS(t,"svg");l.setAttribute("aria-hidden","true"),l.setAttribute("viewBox","0 0 14 14"),l.setAttribute("width","14"),l.setAttribute("height","14"),l.classList.add("svg-icon","iconClearSm");const g=m.createElementNS(t,"path");return g.setAttribute("d","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"),l.append(g),d.append(l),n.append(c,o,d),s.append(n),s})(i,e)),{once:!0}),a.addEventListener("click",e=>{e.preventDefault();e=m.getElementById(i);e&&null!==Stacks&&void 0!==Stacks&&Stacks.showModal(e)})}})(s)})((window,document),location);