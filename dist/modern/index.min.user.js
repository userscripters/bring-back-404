// ==UserScript==
// @author          Oleg Valter <oleg.a.valter@gmail.com>
// @description     Brings back 404 pages to Stack Exchange network
// @grant           GM_deleteValue
// @grant           GM_getValue
// @grant           GM_listValues
// @grant           GM_setValue
// @homepage        https://github.com/userscripters/bring-back-404#readme
// @match           https://*.stackexchange.com/*
// @match           https://askubuntu.com/*
// @match           https://es.meta.stackoverflow.com/*
// @match           https://es.stackoverflow.com/*
// @match           https://ja.meta.stackoverflow.com/*
// @match           https://ja.stackoverflow.com/*
// @match           https://mathoverflow.net/*
// @match           https://meta.askubuntu.com/*
// @match           https://meta.mathoverflow.net/*
// @match           https://meta.serverfault.com/*
// @match           https://meta.stackoverflow.com/*
// @match           https://meta.superuser.com/*
// @match           https://pt.meta.stackoverflow.com/*
// @match           https://pt.stackoverflow.com/*
// @match           https://ru.meta.stackoverflow.com/*
// @match           https://ru.stackoverflow.com/*
// @match           https://serverfault.com/*
// @match           https://stackapps.com/*
// @match           https://stackoverflow.com/*
// @match           https://superuser.com/*
// @name            Bring Back 404
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/bring-back-404.git
// @supportURL      https://github.com/userscripters/bring-back-404/issues
// @version         1.2.0
// ==/UserScript==

"use strict";((g,t,m,u)=>{var[,e]=Object.entries({GM_setValue:{get length(){return GM_listValues().length},clear(){const e=GM_listValues();return e.forEach(e=>GM_deleteValue(e))},key(e){return GM_listValues()[e]},getItem(e){return GM_getValue(e)},setItem(e,t){return GM_setValue(e,t)},removeItem(e){return GM_deleteValue(e)}},GM:{get length(){return GM.listValues().then(e=>e.length)},async clear(){const e=await GM.listValues();return e.forEach(e=>GM.deleteValue(e))},async key(e){return(await GM.listValues())[e]},async getItem(e){const t=await GM.getValue(e);return void 0===t?null:null===t||void 0===t?void 0:t.toString()},setItem(e,t){return GM.setValue(e,t)},removeItem(e){return GM.deleteValue(e)}}}).find(([e])=>void 0!==t[e])||[];class p{static clear(){const{storage:e,prefix:t}=this;e.removeItem(t)}static async open(){const{storage:e,prefix:t}=this;var a=await e.getItem(t);return a?JSON.parse(a):{}}static async load(e,t){e=(await p.open())[e];return void 0!==e?e:t}static async save(e,t){const{storage:a,prefix:s}=this,i=await p.open();return i[e]=t,a.setItem(s,JSON.stringify(i))}static async toggle(e){return p.save(e,!await p.load(e))}static async remove(e){var t=this["prefix"];const a=await this.load(t,{});return delete a[e],p.save(e,a)}}p.storage=e||localStorage,p.prefix="bring-back-404";const h=(e,{classes:t=[],placeholder:a="",title:s="",value:i=""}={})=>{const n=m.createElement("div"),r=(n.classList.add("d-flex","gs4","gsy","fd-column",...t),m.createElement("div")),c=(r.classList.add("d-flex","ps-relative"),m.createElement("input"));if(c.classList.add("s-input"),c.id=e,c.type="text",c.placeholder=a,c.value=i,r.append(c),n.append(r),s){const l=m.createElement("div"),o=(l.classList.add("flex--item"),m.createElement("label"));return o.classList.add("d-block","s-label"),o.htmlFor=e,o.textContent=s,l.append(o),n.prepend(l),[n,c,o]}return[n,c]},b=(e,t)=>{var a="http://www.w3.org/2000/svg";const[s,i]=((e,t,a)=>{const s=m.createElementNS(a,"svg"),i=(s.classList.add("svg-icon",e),s.setAttribute("width","18"),s.setAttribute("height","18"),s.setAttribute("viewBox","0 0 18 18"),s.setAttribute("aria-hidden","true"),m.createElementNS(a,"path"));return i.setAttribute("d",t),s.append(i),[s,i]})("iconGlobe",`M9 1C4.64 1 1 4.64 1 9c0 4.36 3.64 8 8 8 4.36 0 8-3.64 8-8
            0-4.36-3.64-8-8-8zM8 15.32a6.46 6.46 0 01-4.3-2.74 6.46 6.46
            0 0 1-.93-5.01L7 11.68v.8c0 .88.12 1.32 1
            1.32v1.52zm5.72-2c-.2-.66-1-1.32-1.72-1.32h-1v-2c0-.44-.56-1-1-1H6V7h1c.44
            0 1-.56 1-1V5h2c.88 0 1.4-.72 1.4-1.6v-.33a6.45 6.45 0 013.83 4.51 6.45 6.45
            0 0 1-1.51 5.73v.01z`,a),n=m.createElementNS(a,"title"),r=(n.textContent=t,s.append(n),m.createElementNS(a,"a"));return r.setAttribute("href",e),r.setAttribute("target","_blank"),r.append(i),s.append(r),s},v=t=>{m.addEventListener("dragstart",({dataTransfer:e})=>{const t=m.createElement("img");t.src="data:image/png;base64,AAAAAA==",null!=e&&e.setDragImage(t,0,0)});let o=0,d=0,a=0,s=!1;const i=({clientX:a,clientY:s})=>{var i,n=m.getElementById(t);if(n){o=o||a,d=d||s;let{top:e,left:t}=n["style"];e||t||(i=g.getComputedStyle(n),e=i.top,t=i.left);const r=a-o,c=s-d;if(![r,c].map(Math.abs).some(e=>500<e)){const l=n["style"];l.left=parseInt(t)+r+"px",l.top=parseInt(e)+c+"px",o=a,d=s}}};m.addEventListener("dragstart",e=>{e=e.target;e===m.getElementById(t)&&(s=!0)}),m.addEventListener("dragend",({target:e})=>{e===m.getElementById(t)&&(s=!1,o=0,d=0)}),m.addEventListener("drag",e=>{if(!(3<=(a=e.clientX?0:a<3?a+1:3))&&s)return i(e)}),m.addEventListener("dragover",e=>{if(s&&e.preventDefault(),!(a<3)&&s)return i(e)})},k=e=>{var t="bring-back-404";const a=m.querySelector("ol.user-logged-in, ol.user-logged-out");if(!a)return console.debug("failed to find main menu");const s=m.getElementById(t)||(e=>{const t=m.createElement("li"),a=(t.classList.add("-item"),t.id=e,t)["dataset"],s=(a.action="s-modal#toggle",m.createElement("a")),i=(s.classList.add("-link"),m.createElement("strong"));return i.textContent="404",s.append(i),t.append(s),t})(t);if(!s.isConnected){a.append(s);const i="bring-back-404-config";s.addEventListener("click",()=>a.append(((e,n)=>{var t="modal-title";const a=m.createElement("aside"),s=(a.classList.add("s-modal"),a.id=e,a.tabIndex=-1,a.setAttribute("role","dialog"),a.setAttribute("aria-labelledby",t),a.setAttribute("aria-describeddy","modal-description"),a.setAttribute("aria-hidden","true"),a)["dataset"],i=(s.sModalTarget="modal",s.controller="s-modal",m.createElement("div")),r=(i.classList.add("s-modal--dialog","ps-relative","hmx6"),i.setAttribute("role","document"),i.id=e+"-document",i.draggable=!0,v(i.id),m.createElement("h1")),c=(r.classList.add("s-modal--header"),r.id=t,r.textContent="Custom 404 Options",m.createElement("form"));c.classList.add("s-modal--body","d-flex","flex__allcells6","fw-wrap","gs16"),c.addEventListener("change",({target:e})=>{const{id:t,value:a}=e,[s,i]=t.split("-");e=n.find(({site:e})=>e===s);e?Object.assign(e,{[i]:a}):n.push(new f({site:s,[i]:a,url:u.hostname})),p.save("overrides",n)});e=n.map(({imageURL:e,site:t,label:a,notFoundURL:s,header:i})=>{a=a||t;const n=m.createElement("div"),[r,,c]=(n.classList.add("flex--item"),h(t+"-imageURL",{value:e,title:a}));c.append(m.createTextNode(" "),b(s,a+" 404 page")),c.classList.add("mb8");var[e]=h(t+"-header",{placeholder:"custom header",value:i||""});return n.append(r,e),n});c.append(...e);const l=m.createElement("button");l.classList.add("s-modal--close","s-btn","s-btn__muted"),l.type="button",l.dataset.action="s-modal#hide";t="http://www.w3.org/2000/svg";const o=m.createElementNS(t,"svg"),d=(o.setAttribute("aria-hidden","true"),o.setAttribute("viewBox","0 0 14 14"),o.setAttribute("width","14"),o.setAttribute("height","14"),o.classList.add("svg-icon","iconClearSm"),m.createElementNS(t,"path"));return d.setAttribute("d","M12 3.41 10.59 2 7 5.59 3.41 2 2 3.41 5.59 7 2 10.59 3.41 12 7 8.41 10.59 12 12 10.59 8.41 7 12 3.41z"),o.append(d),l.append(o),i.append(r,c,l),a.append(i),a})(i,e)),{once:!0}),s.addEventListener("click",e=>{e.preventDefault();var t,e=m.getElementById(i);e&&null!=(t=g.Stacks)&&t.showModal(e)})}};class f{constructor(e){Object.assign(this,e)}get notFoundURL(){var{site:e,url:t}=this;return t||`https://${e}.com/404`}}const L=[{label:"Stack Overflow",site:"stackoverflow",imageURL:"https://i.stack.imgur.com/okzBE.png"},{label:"Meta Stack Overflow",site:"meta.stackoverflow",imageURL:"https://i.stack.imgur.com/0i2to.png"},{label:"Ask Ubuntu",site:"askubuntu",imageURL:"https://i.stack.imgur.com/KopoQ.png"},{label:"Super User",site:"superuser",imageURL:"https://i.stack.imgur.com/hMfYx.png"},{label:"English Language Learners",site:"english.stackexchange",imageURL:"https://i.stack.imgur.com/cQLRt.png"},{label:"Code Review",site:"codereview.stackexchange",imageURL:"https://i.stack.imgur.com/R4Tgd.png"},{label:"Unix & Linux",site:"unix.stackexchange",imageURL:"https://i.stack.imgur.com/XQRh5.png"},{label:"Science Fiction & Fantasy",site:"scifi.stackexchange",imageURL:"https://i.stack.imgur.com/UR35t.png"},{label:"Mathematics",site:"math.stackexchange",imageURL:"https://i.stack.imgur.com/bHpU1.png"},{label:"Server Fault",site:"serverfault",imageURL:"https://i.stack.imgur.com/W7VMk.png"},{label:"Ask Different",site:"apple.stackexchange",imageURL:"https://i.stack.imgur.com/fCIaP.png"},{label:"Cross Validated",site:"stats.stackexchange",imageURL:"https://i.stack.imgur.com/BqaS0.png"},{label:"Arqade",site:"gaming.stackexchange",imageURL:"https://i.stack.imgur.com/C4jC1.png"},{label:"Mi Yodeya",site:"judaism.stackexchange",imageURL:"https://i.stack.imgur.com/048MA.png"},{label:"Webmasters",site:"webmasters.stackexchange",imageURL:"https://i.stack.imgur.com/Z8Y2o.png"},{label:"Cryptography",site:"crypto.stackexchange",imageURL:"https://i.stack.imgur.com/2hyIe.png"},{label:"Seasoned Advice",site:"cooking.stackexchange",imageURL:"https://i.stack.imgur.com/kSX5n.png"},{label:"Home Improvement",site:"diy.stackexchange",imageURL:"https://i.stack.imgur.com/C4P5L.png"},{label:"Chemistry",site:"chemistry.stackexchange",imageURL:"https://i.stack.imgur.com/SwIib.png"},{label:"Raspberry Pi",site:"raspberrypi.stackexchange",imageURL:"https://i.stack.imgur.com/A02um.png"},{label:"Emacs",site:"emacs.stackexchange",imageURL:"https://i.stack.imgur.com/KUafD.png"},{label:"Android Enthusiasts",site:"android.stackexchange",imageURL:"https://i.stack.imgur.com/kgFiY.png"},{label:"Graphic Design",site:"graphicdesign.stackexchange",imageURL:"https://i.stack.imgur.com/FwQQL.png"},{label:"Database Administrators",site:"dba.stackexchange",imageURL:"https://i.stack.imgur.com/ly6am.png"},{label:"Movies & TV",site:"movies.stackexchange",imageURL:"https://i.stack.imgur.com/wCrM9.png"},{label:"Software Recommendations",site:"softwarerecs.stackexchange",imageURL:"https://i.stack.imgur.com/BqikQ.png"},{label:"Academia",site:"academia.stackexchange",imageURL:"https://i.stack.imgur.com/l10yz.png"}].map(e=>new f(e));t.addEventListener("load",async()=>{const e=await p.load("overrides",[]);e.forEach(t=>{var e=L.find(({site:e})=>e===t.site);if(!e)return L.push(new f(t));Object.assign(e,t)});{var t,a=(t=m).createElement("style");t.head.append(a);const n=a["sheet"];n&&(n.insertRule(".s-modal--dialog[draggable=true] { cursor: grab; }"),n.insertRule(".iconGlobe path { fill: var(--black-400) !important; }"))}k(L);t=(await fetch(u.href)).status;if(404===t){const r=u["hostname"],c=r.split(".").slice(0,-1).join(".");a=L.find(({site:e})=>e===c)||new f({site:c,header:"Arrrggghhh!",imageURL:"https://i.stack.imgur.com/ata1R.jpg"});{var[i,{imageURL:t="",site:s}]=[m,a];const l=i.createElement("img");l.src=t,l.alt="Page not found",l.decoding="async",l.width=250,l.style.display="none",l.addEventListener("error",()=>console.debug("failed to load 404 image on "+s)),l.addEventListener("load",()=>{const e=i.getElementById("content");if(!e)return console.debug("missing content modal");const t=e.querySelector("svg.spotAlertXL, [alt='Page not found']");if(!t)return console.debug("missing 404 image");t.replaceWith(l),l.style.display="unset";const a=e.querySelector("h1");if(!a)return console.debug("missing 404 header");a.classList.remove("mt48");const s=a.closest(".d-flex");if(!s)return console.debug("404 content does't use Flexbox");s.classList.replace("ai-start","ai-center")}),i.body.append(l)}{var[t,a]=[m,a["header"]];const o=t.getElementById("content");if(!o)return void console.debug("missing content modal");const d=o.querySelector("h1:not(#question-header > h1)");a&&d&&(d.textContent=a)}}})})("undefined"!=typeof unsafeWindow?unsafeWindow:window,window,document,location);